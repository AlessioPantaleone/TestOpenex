<routes xmlns="http://camel.apache.org/schema/spring">
    <route id="openex-scheduler">
        <from uri="timer:simple?period=5000"/>
        <setHeader headerName="X-Auth-Token">
            <constant>{{openex_token}}</constant>
        </setHeader>
        <to uri="{{openex_inject_fetch}}"/>
        <unmarshal>
            <json library="Gson" unmarshalTypeName="java.lang.Object"/>
        </unmarshal>
        <split executorServiceRef="openex-worker-thread-profile" streaming="true">
            <simple>${body}</simple>
            <setHeader headerName="router-header">
                <simple>${body[exercise_name]}</simple>
            </setHeader>
            <doTry>
                <dynamicRouter ignoreInvalidEndpoints="true">
                    <method ref="schedulerRouter" method="forward"/>
                </dynamicRouter>
                <to uri="direct:callback"/>
                <doCatch>
                    <exception>org.apache.camel.component.direct.DirectConsumerNotAvailableException</exception>
                    <log message="Error calling schedulerRouter for component ${header.router-header}"/>
                    <to uri="mock:routing_error"/>
                </doCatch>
            </doTry>
        </split>
    </route>
    <route id="openex-callback">
        <from uri="direct:callback"/>
        <setHeader headerName="Content-Type">
            <constant>application/json</constant>
        </setHeader>
        <setHeader headerName="CamelHttpMethod">
            <constant>{{callback_mode}}</constant>
        </setHeader>
        <doTry>
            <to uri="{{callback_uri}}"/>
            <doCatch>
                <exception>java.lang.Exception</exception>
                <!-- TODO add logger here -->
                <log message="Error calling callback uri for component ${header.router-header}"/>
                <to uri="mock:callback_error"/>
            </doCatch>
        </doTry>
    </route>
</routes>